---
layout: post
title:  "Unity游戏表格配置方案"
categories: C#
tags: 游戏 Unity 表格 配置
author: zack.zhang
---

* content
{:toc}

## 简介

游戏中通常会用到许多数据，一种是玩家在游戏过程中产生的数据，通常这些数据会被存储到数据库端，客户端需要远程拉取；另一种是设计者为玩家预先设置好的数据，这些数据构建出了整个游戏世界，而且不以玩家实时行为为转移，每一份这种数据都是对游戏某一方面或者某一特性做出的一种描述。本文主要关心的话题是后者，介绍我在游戏开发过程中实现的一套表格数据配置系统。

<!-- more -->
## 技术选型

### 1. 序列化技术

通常序列化技术模型可以分为关系模型和非关系模型。举个例子，采用非关系模型的序列化技术比如xml、JSON等，关系模型的序列化技术比如excel。
那么什么是关系模型呢？关系模型全称关系数据模型，它是以数学中集合论中的关系概念为基础发展起来的。关系模型无论是实体还是实体间的联系均由单一的结构类型——关系来表示。
以下为两种模型的特性及优缺点。

<table>
  <thead>
    <tr>
      <th>类型</th>
      <th>特性</th>
      <th>优点</th>
	  <th>缺点</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>关系模型</td>
      <td>二维表格模型</td>
      <td>1. 容易理解：二维表结构是非常贴近逻辑世界一个概念，关系模型相对网状、层次等其他模型来说更容易理解；<br/>2. 易于维护：<a href="https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E5%AE%8C%E6%95%B4%E6%80%A7/110071?fr=aladdin">数据完整性</a>大大降低了数据冗余和数据不一致的概率；<br/>3. 二维结构易于批量处理数据；</td>
	  <td>1. 为了维护完整性，读写数据量变大；<br/>2. 固定的表结构；</td>
    </tr>
    <tr>
      <td>非关系模型</td>
      <td>键值对存储数据</td>
      <td>1. 基于键值对的存储方式，使数据没有耦合性，容易扩展；<br/>2. 数据不用维护完整性，数据量相对较小，适用于保存海量数据</td>
	  <td>1. 结构复杂，阅读成本高；<br/>2. 难于批量处理数据；</td>
    </tr>
  </tbody>
</table>
在Unity里面，大部分可序列化对象都最终会以非关系模型来保存数据，比如预制体对象（.prefab）、材质对象（.mat）。思考一个问题，如果要批量修改预制体怎么办？也许就需要写一段Editor代码去实现批量操作，成本非常高。再思考一个问题，怎么去阅读一个预制体里的内容？显然直接打开一个文本很不直观，就需要有图形化界面去显示每一个对象的数据。由于设计和数据模型特性，Unity使用非关系模型序列化数据没问题，但是如果要在成本可控范围内去让策划更方便地维护数据，非关系模型显然成本太高。所以本文主要采用关系模型，即Excel表格。

### 2. Excel类型

通常使用Excel的思路有两种：1. 使用电子表格格式（.xls/.xlsx工作表）；2. 使用CSV格式。其中CSV格式由于分隔符不同，分为tab分隔符和逗号分隔符两种格式。

首先来说这两种Excel格式都是被业内比较普遍的使用的，接下来介绍一下两种格式的不同点。

#### 2.1 电子表格格式（.xls/.xlsx工作表）

电子表格格式作为一种二进制格式，通常需要专门的解析工具才能读取文件中的内容。但是如果将其直接应用到游戏里，也就是说将xls直接解析读取到内存中，将会得到很多冗余的信息，浪费内存。因此业内普遍做法如下图所示。<br/>

![xls flow](https://zd304.github.io/assets/img/xls_flow.png)<br/>

优点：
> * 由于源文件使用xls格式，所以Excel的内部单元格信息得以保存下来，比如设置某一格的颜色，以及对某一格的注释。
> * 导表工具如果直接导出成代码里对应类的结构，并保存成二进制，加载的时候省去了很多解析的过程，很小程度上对提升加载速度和较小包体有帮助。

缺点：
> * 编辑完表格还需要把表格转成游戏数据，工作步骤繁复且容易遗忘。
> * 配合项目版本管理软件，无法做到解决冲突，冲突时只能全部覆盖替换。

#### 2.2 CSV格式

CSV格式本质上就是文本文件，因此CSV格式文本不需要专门的解析工具即可读取文件中的内容。CSV格式有两种，需要注意的是，逗号分隔符的CSV格式通常为UTF-8编码格式，tab分隔符的CSV格式通常为Unicode编码方式（2字节存储）。

首先分析一下CSV格式和电子表格格式优缺点。

优点：
> * 无需转表，游戏可以直接读取文本，简化工作流程，提升团队工作效率。
> * 便于版本管理，遇到冲突可以从容解决。

缺点：
> * xls内部单元格信息无法保存下来，比如要给某一格上色、冻结某一行或者加注释都是无法实现的。
> * 游戏加载时候需要写解析逻辑，要把字符串转为对应数据，很小程度上增加加载时间。

其次分析一下两种CSV的优缺点。

* 逗号分隔符的CSV格式：很多时候游戏数据里就会有逗号，很容易跟分隔符的逗号产生歧义，增加解析风险，增加编辑难度。
* tab分隔符的CSV格式：2字节存储浪费空间。

### 2.3 综合分析

* 表格单元格信息其实可有可无，有时候太多太复杂的单元格信息，反而会让表格排版变得混乱、不清洁
* 简化工作流程，提升团队工作效率，在项目量级越大越能体现出其优势

综合分析，作者更偏爱使用tab格式的CSV格式来存储游戏数据。本文也重点探讨一种使用tab格式的CSV格式来存储游戏数据的方案。